<!-- reports/templates/reports/analytics_dashboard.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}Аналитический дашборд{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Аналитический дашборд</h1>
                <div>
                    <button type="button" class="btn btn-outline-secondary" id="refresh-dashboard">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                    <button type="button" class="btn btn-primary" id="export-dashboard">
                        <i class="fas fa-download"></i> Экспорт
                    </button>
                </div>
            </div>

            <!-- Фильтры дашборда -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="dashboard-filters" class="row g-3">
                        <div class="col-md-3">
                            <label for="period" class="form-label">Период</label>
                            <select class="form-select" id="period" name="period">
                                <option value="today">Сегодня</option>
                                <option value="yesterday">Вчера</option>
                                <option value="week" selected>Неделя</option>
                                <option value="month">Месяц</option>
                                <option value="quarter">Квартал</option>
                                <option value="year">Год</option>
                                <option value="custom">Произвольный</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="date_from" class="form-label">С даты</label>
                            <input type="date" class="form-control" id="date_from" name="date_from"
                                   value="{{ default_date_from }}">
                        </div>
                        <div class="col-md-2">
                            <label for="date_to" class="form-label">По дату</label>
                            <input type="date" class="form-control" id="date_to" name="date_to"
                                   value="{{ default_date_to }}">
                        </div>
                        <div class="col-md-3">
                            <label for="metric_group" class="form-label">Группа метрик</label>
                            <select class="form-select" id="metric_group" name="metric_group">
                                <option value="all">Все метрики</option>
                                <option value="financial">Финансовые</option>
                                <option value="clients">Клиентские</option>
                                <option value="operations">Операционные</option>
                                <option value="marketing">Маркетинговые</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter"></i> Применить
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- KPI карточки -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-primary text-white mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="text-xs font-weight-bold text-uppercase mb-1">
                                        Общая выручка
                                    </div>
                                    <div class="h5 mb-0">{{ kpi.total_revenue|floatformat:2 }} ₽</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-dollar-sign fa-2x"></i>
                                </div>
                            </div>
                            <div class="mt-2 text-xs">
                                <span class="text-success">
                                    <i class="fas fa-arrow-up"></i> {{ kpi.revenue_growth }}%
                                </span>
                                С прошлого периода
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-success text-white mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="text-xs font-weight-bold text-uppercase mb-1">
                                        Новые клиенты
                                    </div>
                                    <div class="h5 mb-0">{{ kpi.new_clients }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-user-plus fa-2x"></i>
                                </div>
                            </div>
                            <div class="mt-2 text-xs">
                                <span class="text-warning">
                                    <i class="fas fa-arrow-up"></i> {{ kpi.client_growth }}%
                                </span>
                                С прошлого периода
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-warning text-dark mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="text-xs font-weight-bold text-uppercase mb-1">
                                        Средний чек
                                    </div>
                                    <div class="h5 mb-0">{{ kpi.avg_transaction|floatformat:2 }} ₽</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-receipt fa-2x"></i>
                                </div>
                            </div>
                            <div class="mt-2 text-xs">
                                <span class="text-success">
                                    <i class="fas fa-arrow-up"></i> {{ kpi.avg_check_growth }}%
                                </span>
                                С прошлого периода
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-info text-white mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="text-xs font-weight-bold text-uppercase mb-1">
                                        Конверсия
                                    </div>
                                    <div class="h5 mb-0">{{ kpi.conversion_rate }}%</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-percentage fa-2x"></i>
                                </div>
                            </div>
                            <div class="mt-2 text-xs">
                                <span class="text-success">
                                    <i class="fas fa-arrow-up"></i> {{ kpi.conversion_growth }}%
                                </span>
                                С прошлого периода
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Графики и диаграммы -->
            <div class="row">
                <!-- График выручки по дням -->
                <div class="col-xl-8 col-lg-7">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-line"></i> Динамика выручки
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-area">
                                <canvas id="revenueChart" width="100%" height="40"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Распределение по типам клиентов -->
                <div class="col-xl-4 col-lg-5">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie"></i> Распределение клиентов
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-pie">
                                <canvas id="clientsChart" width="100%" height="50"></canvas>
                            </div>
                            <div class="mt-4 text-center small">
                                {% for segment in client_segments %}
                                <span class="me-3">
                                    <i class="fas fa-circle segment-icon" data-color="{{ segment.color|default:'#6c757d' }}"></i>
                                    {{ segment.label }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Дополнительные метрики -->
            <div class="row">
                <!-- Топ транзакций -->
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list-ol"></i> Крупнейшие транзакции
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Клиент</th>
                                            <th>Тип</th>
                                            <th>Сумма</th>
                                            <th>Дата</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in top_transactions %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm bg-light rounded me-2">
                                                        <div class="avatar-title bg-{{ transaction.type_color|default:'primary' }} text-white rounded-circle">
                                                            {{ transaction.client_name|first|upper }}
                                                        </div>
                                                    </div>
                                                    {{ transaction.client_name }}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ transaction.type_color|default:'primary' }}">
                                                    {{ transaction.type_display }}
                                                </span>
                                            </td>
                                            <td class="text-nowrap">{{ transaction.amount|floatformat:2 }} ₽</td>
                                            <td class="text-nowrap">{{ transaction.date|date:"d.m.Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Активность по часам -->
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-bar"></i> Активность по часам
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-bar">
                                <canvas id="activityChart" width="100%" height="50"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Географическое распределение -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-map-marker-alt"></i> Географическое распределение клиентов
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div id="map-container" style="height: 300px; background: #f8f9fa; border-radius: 0.375rem;">
                                        <div class="d-flex justify-content-center align-items-center h-100 text-muted">
                                            <div class="text-center">
                                                <i class="fas fa-map fa-3x mb-3"></i>
                                                <p>Интерактивная карта будет отображена здесь</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6>Топ регионов</h6>
                                    <div class="list-group list-group-flush">
                                        {% for region in top_regions %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ region.name }}
                                            <span class="badge bg-primary rounded-pill">{{ region.clients_count }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Данные для графиков
const revenueData = {
    labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
    values: [12000, 19000, 15000, 25000, 22000, 18000, 14000]
};

const clientSegments = {
    labels: ['VIP', 'Корпоративные', 'Физические лица', 'Государственные'],
    values: [15, 25, 45, 15],
    colors: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e']
};

const activityData = {
    labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
    values: [45, 30, 120, 180, 150, 90]
};

// Инициализация графиков
document.addEventListener('DOMContentLoaded', function() {
    // Установка цветов для иконок сегментов
    document.querySelectorAll('.segment-icon').forEach(icon => {
        const color = icon.getAttribute('data-color');
        icon.style.color = color;
    });

    // График выручки
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: revenueData.labels,
            datasets: [{
                label: 'Выручка',
                data: revenueData.values,
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('ru-RU') + ' ₽';
                        }
                    }
                }
            }
        }
    });

    // Круговая диаграмма клиентов
    const clientsCtx = document.getElementById('clientsChart').getContext('2d');
    const clientsChart = new Chart(clientsCtx, {
        type: 'doughnut',
        data: {
            labels: clientSegments.labels,
            datasets: [{
                data: clientSegments.values,
                backgroundColor: clientSegments.colors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // График активности по часам
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(activityCtx, {
        type: 'bar',
        data: {
            labels: activityData.labels,
            datasets: [{
                label: 'Транзакции',
                data: activityData.values,
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Обработка фильтров
    document.getElementById('dashboard-filters').addEventListener('submit', function(e) {
        e.preventDefault();
        refreshDashboard();
    });

    // Обработка изменения периода
    document.getElementById('period').addEventListener('change', function() {
        const period = this.value;
        const dateFrom = document.getElementById('date_from');
        const dateTo = document.getElementById('date_to');

        if (period !== 'custom') {
            const today = new Date();
            let fromDate = new Date();

            switch (period) {
                case 'today':
                    fromDate = today;
                    break;
                case 'yesterday':
                    fromDate = new Date(today.setDate(today.getDate() - 1));
                    break;
                case 'week':
                    fromDate = new Date(today.setDate(today.getDate() - 7));
                    break;
                case 'month':
                    fromDate = new Date(today.setMonth(today.getMonth() - 1));
                    break;
                case 'quarter':
                    fromDate = new Date(today.setMonth(today.getMonth() - 3));
                    break;
                case 'year':
                    fromDate = new Date(today.setFullYear(today.getFullYear() - 1));
                    break;
            }

            dateFrom.value = fromDate.toISOString().split('T')[0];
            dateTo.value = new Date().toISOString().split('T')[0];
        }
    });

    // Обработка обновления дашборда
    document.getElementById('refresh-dashboard').addEventListener('click', refreshDashboard);

    // Обработка экспорта дашборда
    document.getElementById('export-dashboard').addEventListener('click', exportDashboard);
});

function refreshDashboard() {
    const form = document.getElementById('dashboard-filters');
    const formData = new FormData(form);

    // Показываем индикатор загрузки
    const refreshBtn = document.getElementById('refresh-dashboard');
    const originalHtml = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
    refreshBtn.disabled = true;

    // Здесь должна быть логика обновления дашборда
    setTimeout(() => {
        alert('Дашборд обновлен с новыми параметрами фильтрации');
        refreshBtn.innerHTML = originalHtml;
        refreshBtn.disabled = false;
    }, 1000);
}

function exportDashboard() {
    const format = prompt('Выберите формат экспорта (PNG, PDF, Excel):', 'PNG');
    if (format) {
        alert(`Дашборд будет экспортирован в формате ${format}. Функция будет реализована в следующей версии.`);
    }
}

// Автообновление дашборда каждые 5 минут
setInterval(refreshDashboard, 300000);
</script>
{% endblock %}