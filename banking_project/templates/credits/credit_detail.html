{% extends 'base.html' %}

{% block title %}Кредит {{ credit.contract_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'credits:credit_list' %}">Все кредиты</a></li>
            <li class="breadcrumb-item active">Кредит {{ credit.contract_number }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Информация о кредите</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Клиент:</strong><br>
                            <a href="{% url 'clients:client_detail' credit.client.id %}">{{ credit.client.get_full_name }}</a></p>
                            <p><strong>Кредитный продукт:</strong><br>{{ credit.credit_product.name }}</p>
                            <p><strong>Сумма кредита:</strong><br>{{ credit.amount }} {{ credit.account.currency.code }}</p>
                            <p><strong>Остаток долга:</strong><br>{{ credit.remaining_balance }} {{ credit.account.currency.code }}</p>
                            <p><strong>Всего выплачено:</strong><br>{{ credit.total_paid }} {{ credit.account.currency.code }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Статус:</strong><br>
                                {% if credit.status == 'application' %}
                                <span class="badge bg-warning">Заявка</span>
                                {% elif credit.status == 'under_review' %}
                                <span class="badge bg-info">На рассмотрении</span>
                                {% elif credit.status == 'approved' %}
                                <span class="badge bg-success">Одобрен</span>
                                {% elif credit.status == 'active' %}
                                <span class="badge bg-primary">Активен</span>
                                {% elif credit.status == 'closed' %}
                                <span class="badge bg-secondary">Закрыт</span>
                                {% elif credit.status == 'overdue' %}
                                <span class="badge bg-danger">Просрочен</span>
                                {% else %}
                                <span class="badge bg-dark">{{ credit.get_status_display }}</span>
                                {% endif %}
                            </p>
                            <p><strong>Процентная ставка:</strong><br>{{ credit.interest_rate }}%</p>
                            <p><strong>Срок кредита:</strong><br>{{ credit.term_months }} месяцев</p>
                            <p><strong>Дата выдачи:</strong><br>{{ credit.start_date|date:"d.m.Y" }}</p>
                            <p><strong>Дата окончания:</strong><br>{{ credit.end_date|date:"d.m.Y" }}</p>
                        </div>
                    </div>
                    {% if credit.purpose %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <p><strong>Цель кредита:</strong><br>{{ credit.purpose }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- НОВЫЙ БЛОК: Информация о платежах -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Ближайший платеж</h6>
                        </div>
                        <div class="card-body">
                            {% if credit.next_payment_date %}
                            <p><strong>Дата платежа:</strong> {{ credit.next_payment_date|date:"d.m.Y" }}</p>
                            <p><strong>Сумма платежа:</strong> {{ next_payment_amount }} {{ credit.account.currency.code }}</p>
                            {% if penalty_amount > 0 %}
                            <p><strong>Штрафы:</strong> {{ penalty_amount }} {{ credit.account.currency.code }}</p>
                            <p><strong>Всего к оплате:</strong> {{ total_due }} {{ credit.account.currency.code }}</p>
                            {% endif %}
                            <a href="{% url 'credits:credit_payment' credit.id %}" class="btn btn-sm btn-primary mt-2">
                                Внести платеж
                            </a>
                            {% else %}
                            <p class="text-muted">Платежи отсутствуют</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Статистика</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Просроченная сумма:</strong> {{ credit.overdue_amount }} {{ credit.account.currency.code }}</p>
                            <p><strong>Дней просрочки:</strong> {{ credit.overdue_days }}</p>
                            <p><strong>Выполнено платежей:</strong> {{ credit.payments.count }}</p>
                            {% if can_early_repay %}
                            <p><strong>Досрочное погашение:</strong>
                                <span class="text-success">Доступно</span>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- НОВЫЙ БЛОК: Последние платежи -->
            {% if recent_payments %}
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">Последние платежи</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Сумма</th>
                                    <th>Основной долг</th>
                                    <th>Проценты</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in recent_payments %}
                                <tr>
                                    <td>{{ payment.payment_date|date:"d.m.Y" }}</td>
                                    <td>{{ payment.amount }} {{ credit.account.currency.code }}</td>
                                    <td>{{ payment.principal_amount }} {{ credit.account.currency.code }}</td>
                                    <td>{{ payment.interest_amount }} {{ credit.account.currency.code }}</td>
                                    <td>
                                        <span class="badge {% if payment.status == 'completed' %}bg-success{% elif payment.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ payment.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <a href="{% url 'credits:payment_history' credit.id %}" class="btn btn-outline-primary btn-sm">
                        Вся история платежей
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Действия</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if credit.status == 'application' or credit.status == 'under_review' %}
                            {% if user.role == 'employee' or user.role == 'admin' %}
                            <a href="{% url 'credits:credit_approve' credit.id %}" class="btn btn-success">Одобрить</a>
                            <a href="{% url 'credits:credit_reject' credit.id %}" class="btn btn-danger">Отклонить</a>
                            {% endif %}
                        {% endif %}

                        {% if credit.status == 'active' %}
                        <a href="{% url 'credits:credit_payment' credit.id %}" class="btn btn-primary">Внести платеж</a>

                        {% if can_early_repay %}
                        <a href="{% url 'credits:early_repayment' credit.id %}" class="btn btn-warning">Досрочное погашение</a>
                        {% endif %}

                        <a href="{% url 'credits:payment_schedule' credit.id %}" class="btn btn-outline-info">График платежей</a>
                        {% endif %}

                        <a href="{% url 'credits:payment_history' credit.id %}" class="btn btn-outline-primary">История платежей</a>

                        {% if user.role == 'employee' or user.role == 'admin' %}
                        <a href="{% url 'credits:credit_collaterals' credit.id %}" class="btn btn-outline-warning">Залоги</a>
                        <a href="{% url 'credits:credit_update' credit.id %}" class="btn btn-outline-secondary">Редактировать</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- НОВЫЙ БЛОК: Информация о досрочном погашении -->
            {% if can_early_repay %}
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h6 class="mb-0 text-white">Досрочное погашение</h6>
                </div>
                <div class="card-body">
                    <p class="small">Вы можете погасить кредит досрочно. Сумма для полного погашения:</p>
                    <h5 class="text-center text-success">{{ early_repayment_amount }} {{ credit.account.currency.code }}</h5>
                    <a href="{% url 'credits:early_repayment' credit.id %}" class="btn btn-warning w-100 mt-2">
                        Погасить досрочно
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- НОВЫЙ БЛОК: Быстрые ссылки -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Быстрые ссылки</h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="{% url 'credits:payment_schedule' credit.id %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-calendar-alt me-2"></i>График платежей
                        </a>
                        <a href="{% url 'credits:payment_history' credit.id %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-history me-2"></i>История платежей
                        </a>
                        {% if credit.overdue_days > 0 %}
                        <a href="{% url 'credits:calculate_penalty' credit.id %}" class="list-group-item list-group-item-action text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Расчет штрафов
                        </a>
                        {% endif %}
                        <a href="{% url 'clients:client_detail' credit.client.id %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-user me-2"></i>Профиль клиента
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}